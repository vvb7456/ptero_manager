# 艾萝工坊统一绿皮运维管理系统 - 使用与维护手册

## 目录

- [第一部分：部署与维护指南 (面向维护人员)](#第一部分部署与维护指南-面向维护人员)
  - [1. 简介](#1-简介)
  - [2. 环境准备](#2-环境准备)
  - [3. 安装步骤](#3-安装步骤)
  - [4. 核心配置 (`settings.json`)](#4-核心配置-settingsjson)
  - [5. 运行与管理](#5-运行与管理)
  - [6. 生产环境最佳实践 (使用 systemd)](#6-生产环境最佳实践-使用-systemd)
  - [7. 故障排查](#7-故障排查)
- [第二部分：系统使用手册 (面向最终用户/操作员)](#第二部分系统使用手册-面向最终用户操作员)
  - [1. 登录](#1-登录)
  - [2. 仪表盘](#2-仪表盘)
  - [3. 服务器列表](#3-服务器列表)
  - [4. 用户列表](#4-用户列表)
  - [5. 创建服务器](#5-创建服务器)
  - [6. 邮件模板](#6-邮件模板)
  - [7. 自动化](#7-自动化)
  - [8. 系统设置](#8-系统设置)

---

## 第一部分：部署与维护指南 (面向维护人员)

本部分面向需要部署、配置和维护此系统的技术人员。

### 1. 简介

本系统是一个基于 Flask 和 Pterodactyl API 的 Web 管理面板。它旨在简化对 Pterodactyl 面板上服务器生命周期的管理，核心功能包括：
- 统一的服务器到期时间管理与续期。
- 自动化的服务器冻结、删除和到期邮件提醒。
- 友好的 Web UI，用于批量管理服务器和用户。
- 灵活的服务器创建和资源配置。

### 2. 环境准备

在部署前，请确保您的服务器满足以下条件：
- **操作系统**: Linux (推荐 CentOS 7+, Debian 9+, Ubuntu 18.04+)
- **Python**: 版本 3.8 或更高。
- **pip**: Python 包管理工具。
- **虚拟环境**: `venv` (Python 自带) 或 `virtualenv`。
- **网络**: 服务器必须能访问您要管理的 Pterodactyl 面板的 URL。

### 3. 安装步骤

1.  **获取项目文件**
    将项目的所有文件（`app.py`, `requirements.txt`, `manager.sh` 等）上传到您服务器的一个目录，例如 `/opt/ptero-manager`。

2.  **创建并激活虚拟环境**
    在项目根目录下执行以下命令，创建并激活 Python 虚拟环境。这能确保项目的依赖与系统其他 Python 应用隔离。
    ```bash
    # 进入项目目录
    cd /opt/ptero-manager

    # 创建虚拟环境 (文件夹名为 venv)
    python3 -m venv venv

    # 激活虚拟环境
    source venv/bin/activate
    ```
    成功激活后，您的命令行提示符前会显示 `(venv)`。

3.  **安装依赖**
    在已激活的虚拟环境中，使用 `pip` 安装所有必需的 Python 包。
    ```bash
    pip install -r requirements.txt
    ```

4.  **授权管理脚本**
    为 `manager.sh` 脚本添加可执行权限。
    ```bash
    chmod +x manager.sh
    ```

### 4. 核心配置 (`settings.json`)

系统的大部分配置通过项目根目录下的 `settings.json` 文件进行管理。首次启动前，请务必创建并编辑此文件。以下是关键配置项说明：

-   `ADMIN_PASSWORD`: **(必需)** 登录本管理系统的密码。
-   `PTERO_PANEL_URL`: **(必需)** 您的 Pterodactyl 面板的完整 URL，例如 `http://panel.example.com`。
-   `PTERO_API_KEY`: **(必需)** Pterodactyl 的 Application API Key。
    -   **获取方法**: 登录 Pterodactyl 面板 -> 右上角头像 -> Application API -> Create New，给予所有权限（或至少用户、服务器、节点、Nest、Egg 的读写权限）。
-   `SMTP_HOST`, `SMTP_PORT`, `SMTP_PASSWORD`, `SENDER_EMAIL`: **(必需，若需邮件功能)**
    -   `SMTP_HOST`: 您的 SMTP 服务器地址。
    -   `SMTP_PORT`: SMTP 端口 (例如 465 for SSL, 587 for TLS)。
    -   `SMTP_PASSWORD`: SMTP 密码或授权码。**此密码必须对 `SENDER_EMAIL` 中的所有邮箱都有效。**
    -   `SENDER_EMAIL`: 发件人邮箱地址池。可以填一个或多个邮箱，用逗号 `,` 分隔。系统会轮流使用这些邮箱进行登录和发送，以规避单一邮箱的发送频率限制。
    -   `SMTP_USE_SSL`: 如果端口是 SSL 端口（如465），设为 `true`，否则设为 `false`。
-   `AUTOMATION_*`: 自动化任务相关配置，可以在 Web UI 中修改，但首次配置在这里完成更方便。

### 5. 运行与管理

请 **不要** 直接使用 `python app.py` 在生产环境中运行。请务必使用 `manager.sh` 脚本，它会以后台守护进程模式启动 Gunicorn 生产服务器。

-   **启动服务**:
    ```bash
    ./manager.sh start
    ```
    成功后，应用将在 `0.0.0.0:5000` 上监听。您会看到 PID 和日志目录信息。

-   **停止服务**:
    ```bash
    ./manager.sh stop
    ```

-   **重启服务**:
    ```bash
    ./manager.sh restart
    ```

-   **查看服务状态**:
    ```bash
    ./manager.sh status
    ```

### 6. 生产环境最佳实践 (使用 systemd)

为了确保应用能在服务器重启后自动运行，并由系统统一管理，强烈建议使用 `systemd`。

1.  **创建 systemd 服务文件**:
    在 `/etc/systemd/system/` 目录下创建一个名为 `ptero-manager.service` 的文件：
    ```bash
    sudo nano /etc/systemd/system/ptero-manager.service
    ```

2.  **编辑服务文件**:
    将以下内容粘贴到文件中，并根据您的实际情况修改 `User` 和 `WorkingDirectory`。

    ```ini
    [Unit]
    Description=Ptero Manager Gunicorn Service
    After=network.target

    [Service]
    # 修改为运行此脚本的用户名
    User=root
    # 修改为您的项目根目录
    WorkingDirectory=/opt/ptero-manager
    
    # 启动命令
    ExecStart=/opt/ptero-manager/manager.sh start
    # 停止命令
    ExecStop=/opt/ptero-manager/manager.sh stop
    # 重启命令
    ExecReload=/opt/ptero-manager/manager.sh restart
    
    Type=forking
    Restart=always
    RestartSec=5s
    PIDFile=/opt/ptero-manager/ptero_manager.pid

    [Install]
    WantedBy=multi-user.target
    ```

3.  **管理服务**:
    -   **重载 systemd 配置**: `sudo systemctl daemon-reload`
    -   **启动服务**: `sudo systemctl start ptero-manager`
    -   **设置开机自启**: `sudo systemctl enable ptero-manager`
    -   **查看服务状态**: `sudo systemctl status ptero-manager`
    -   **停止服务**: `sudo systemctl stop ptero-manager`
    -   **重启服务**: `sudo systemctl restart ptero-manager`

### 7. 故障排查

-   **检查日志**: 所有的运行时信息和错误都会记录在项目根目录下的 `logs/` 文件夹中。
    -   `error.log`: **首要排查文件**。记录了 Gunicorn 和应用的所有错误信息，包括自动化任务的失败详情。
    -   `access.log`: 记录了所有 HTTP 请求的访问日志。
-   **常见问题**:
    -   **无法启动/启动失败**:
        -   确保虚拟环境已正确安装所有依赖 (`pip install -r requirements.txt`)。
        -   在 `manager.sh` 脚本中，`gunicorn` 命令可能找不到。请确保您在安装和运行时都激活了虚拟环境。
    -   **API 请求失败 (页面提示错误)**:
        -   检查 `settings.json` 中的 `PTERO_PANEL_URL` 和 `PTERO_API_KEY` 是否正确。
        -   确保服务器可以访问到 Pterodactyl 面板的 URL。
    -   **自动化任务不执行**:
        -   在 Web UI 中确认自动化任务已启用。
        -   检查 `logs/error.log` 文件，看是否有任务执行失败的记录。
        -   **修改了自动化配置后，必须重启应用 (`./manager.sh restart` 或 `sudo systemctl restart ptero-manager`) 才能使新的调度生效。**

---

## 第二部分：系统使用手册 (面向最终用户/操作员)

本部分面向日常使用此 Web 界面的操作人员。

### 1. 登录

访问 `http://<您的服务器IP>:5000`，输入管理员在 `settings.json` 中设置的密码即可登录。

### 2. 仪表盘

登录后的默认页面，提供系统核心指标的概览：
- **用户总数/服务器总数**: 从 Pterodactyl 面板实时同步的数据。
- **正常服务器**: 当前所有非冻结状态的服务器数量。
- **服务器状态分布**: 一个条形图，直观展示“正常”、“即将到期”、“已到期”、“已冻结”和“永久”状态的服务器数量。

### 3. 服务器列表

这是最核心的功能页面，用于管理所有服务器。

-   **筛选、排序和搜索**:
    -   **搜索框**: 可根据服务器名称、所有者用户名进行模糊搜索。
    -   **状态筛选**: 可按“正常”、“即将到期”（7天内）、“已到期”、“永久”等状态筛选服务器。
    -   **排序**: 可按到期时间、服务器ID、服务器名称进行升序或降序排列。
-   **服务器状态说明**:
    -   **正常**: 到期时间在7天之后。
    -   **即将到期**: 到期时间在未来7天之内，以蓝色加粗字体高亮。
    -   **今天**: 当天到期，以橙色加粗字体高亮。
    -   **已过期**: 已过到期时间，以红色加粗字体高亮。
    -   **已冻结**: 服务器在 Pterodactyl 面板上处于冻结 (suspended) 状态，以红色加粗字体高亮。
    -   **永久**: 服务器没有设置到期时间。
-   **单个服务器操作**:
    -   **续期**: 在输入框中填入续期天数（默认为31天），点击“续期”按钮。到期日会从当前日期或原到期日（如果未过期）开始计算。
    -   **冻结/解冻**: 切换服务器在 Pterodactyl 面板的冻结状态。
    -   **删除**: **此操作不可逆！** 将从 Pterodactyl 面板彻底删除该服务器。
-   **批量操作**:
    1.  勾选列表左侧的复选框，选择一个或多个服务器（可点击表头的复选框全选）。
    2.  在页面顶部的“批量操作”区域选择要执行的动作（冻结、解冻、续期、删除、发送通知邮件）。
    3.  如果选择“续期”，需填写天数。
    4.  点击“执行”按钮。删除等危险操作会有二次确认提示。

### 4. 用户列表

管理 Pterodactyl 面板上的所有用户。

-   **筛选、排序和搜索**: 功能与服务器列表类似。
-   **操作**:
    -   **编辑**: 修改用户的用户名、邮箱和姓名。
    -   **查看服务器**: 点击“服务器数量”列的数字，可直接跳转到该用户的所有服务器列表。
-   **批量操作**:
    -   **发送通知邮件**: 使用“邮件模板”中配置的“批量邮件模板”向所有选中的用户发送邮件。
    -   **删除用户**: **此操作不可逆！** 将从 Pterodactyl 面板彻底删除该用户及其名下的所有服务器。

### 5. 创建服务器

提供一个表单来为指定用户创建新服务器。

1.  **选择用户**: 可通过搜索快速定位用户。
2.  **服务器名称**: 选择用户后会自动生成，可自行修改。
3.  **选择预设组(Nest)和预设(Egg)**: 这是创建服务器的核心。选择 Nest 后，Egg 列表会自动加载。选择 Egg 后，下方的“启动指令”和“Egg 环境变量”会自动填充。
4.  **Docker 镜像和启动指令**: 根据 Egg 自动填充，通常无需修改，但高级用户可自定义。
5.  **选择节点和主端口**: 选择服务器要创建在哪个物理节点上，然后从该节点的可用端口列表中选择一个作为主端口。
6.  **资源配置**: 配置 CPU、内存、磁盘等。如果留空，将使用“系统设置”中配置的默认值。
7.  **初始有效天数**: 设置服务器首次创建后的有效期。
8.  点击“立即创建”即可。

### 6. 邮件模板

管理系统发送邮件时使用的内容。

-   **批量邮件模板**: 用于在“服务器列表”或“用户列表”页面手动触发的批量邮件。
-   **自动到期提醒模板**: 用于“自动化”任务，在服务器到期前一天自动发送提醒邮件。
-   **可用变量**: 每个模板下方都列出了可以在主题和正文内容中使用的占位符（如 `{{username}}`, `{{server_list}}` 等），系统在发送时会自动替换为真实数据。

### 7. 自动化

配置后台自动执行的任务。

-   **通用任务时间**: “自动冻结”和“自动删除”任务共享同一个执行时间点，通常建议设在服务器负载较低的凌晨。
-   **自动冻结**: 启用后，系统每天会在指定时间冻结所有 **昨天** 到期的服务器。
-   **自动删除**: 启用后，系统每天会在指定时间删除所有已冻结超过指定天数的服务器。
-   **自动邮件提醒**: 启用后，系统每天会在指定的邮件发送时间点，向所有 **明天** 即将到期的服务器所有者发送提醒邮件。
-   **重要提示**: **任何对自动化设置的修改，都必须重启应用服务 (`./manager.sh restart` 或 `sudo systemctl restart ptero-manager`) 才能让新的调度计划生效。**

### 8. 系统设置

配置系统的基础参数，分为多个板块。

-   **外观设置**: 自定义系统名称和顶部 Banner 图片。
-   **安全设置**: 修改本管理系统的登录密码。
-   **Pterodactyl API 设置**: 配置连接 Pterodactyl 的 URL 和 Key。
-   **SMTP 邮件服务器设置**: 配置邮件发送功能所需的所有参数。
-   **服务器默认配置**: 设置在“创建服务器”页面各项资源的默认值。
-   **重要提示**: **任何对 API、密码、SMTP 或自动化时间的修改，都必须重启应用服务才能在所有后台进程中完全生效。**